<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>상세정보</title>
    <link rel="stylesheet" th:href="@{/css/patientDetail.css}">
</head>
<body>
    <div class="details-container">
        <h1>상세정보</h1>
        <button class="edit-button" id="editBtn">수정버튼</button>
        <div class="patient-info">
            <p>환자 ID: <span th:text="${patient.pid}">USER01</span></p>
            <p>생일: <span th:text="${patient.pBirthDate}">2000-12-31</span></p>
            <p>성별: <span th:text="${patient.pSex}">남</span></p>
        </div>

        <!-- 코멘트 입력 폼 -->
        <div class="comment-section">
            <h2>코멘트 작성</h2>
            <form th:action="@{/patients/updateComment}" method="post" id="commentForm">
                <input type="hidden" th:name="pid" th:value="${patient.pid}">
                <textarea name="comments" rows="4" cols="50" placeholder="코멘트를 입력하세요"></textarea>
                <button type="submit">저장</button>
            </form>
        </div>

        <!-- 저장된 코멘트 목록 -->
		<div class="comment-list">
			<h2>리포트</h2>
		<ul>
			<li th:each="comment, iterStat : ${patient.comments}">
			    <span th:text="${comment}"></span>
			    <form th:action="@{/patients/deleteComment}" method="post" style="display:inline;">
			        <input type="hidden" name="pid" th:value="${patient.pid}" />
			        <input type="hidden" name="commentIndex" th:value="${iterStat.index}" />
			        <button type="submit" class="delete-btn">삭제</button>
			    </form>
			</li>
		</ul>
		</div>

        <button class="back-button" id="backBtn">돌아가기</button>
    </div>

		<script>
		function deleteComment(pid, commentIndex) {
		        // CSRF 토큰 가져오기
		        const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute("content");
		        const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute("content");
		
		        fetch(`/patients/deleteComment?pid=${pid}&commentIndex=${commentIndex}`, {
		            method: 'POST',
		            headers: {
		                [csrfHeader]: csrfToken, // CSRF 헤더 추가
		                'Content-Type': 'application/x-www-form-urlencoded'
		            }
		        })
		        .then(response => {
		            if (response.ok) {
		                alert('코멘트가 삭제되었습니다.');
		                location.reload(); // 페이지 리로드로 업데이트 반영
		            } else {
		                alert('코멘트 삭제에 실패했습니다.');
		            }
		        })
		        .catch(error => alert('오류 발생: ' + error));
		    }
		</script>
		
    <script th:src="@{/js/patientDetail.js}"></script>
    <script>
        document.getElementById('backBtn').addEventListener('click', function() {
            history.back(); // 이전 페이지로 돌아가기
        });

        // 폼이 제출되었을 때 팝업을 띄우는 스크립트
        document.getElementById('commentForm').addEventListener('submit', function(event) {
            event.preventDefault(); // 기본 폼 제출 방지

            // 폼 데이터를 서버에 전송하기 위한 설정
            var formData = new FormData(this);

            fetch('/patients/updateComment', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                // 성공적인 응답 후 팝업 표시
                if (data.success) {
                    alert('코멘트가 저장되었습니다!');
                    // 페이지 리로딩으로 코멘트 목록 갱신
                    location.reload();
                } else {
                    alert('저장 중 오류가 발생했습니다.');
                }
            })
            .catch(error => {
                alert('저장 중 오류가 발생했습니다.');
            });
        });
    </script>
</body>
</html>
