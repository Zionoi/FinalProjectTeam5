<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://unpkg.com/cornerstone-core"></script>
    <script src="https://unpkg.com/cornerstone-wado-image-loader"></script>
    <script src="https://unpkg.com/cornerstone-tools"></script>
    <script src="https://unpkg.com/dicom-parser"></script>
    <script src="https://unpkg.com/cornerstone-math"></script>
    <script src="https://unpkg.com/hammerjs"></script>
    <script src="https://unpkg.com/vtk.js"></script>
  	<link rel="stylesheet" th:href="@{/css/imageView.css}">
    <title>ct3dView</title>
    <style>
        #dicomCanvas {
			height: 816px;
			width: 816px;
            background-color: black;
            display: inline-block;
        }
        #controls {
            display: inline-block;
            vertical-align: top;
            margin-left: 20px;
        }
    </style>
</head>
<body>
	<h2  class="header">DView</h2>
        <div class="sidebar">
			<button id="historyBtn" class="historyBtn" onclick="window.history.back();">
    <h6 class="label">돌아가기</h6>
</button>

		</div>
    <div id="dicomCanvas"></div> <!-- 3D 볼륨 렌더링 영역 -->
    <div id="controls" class="controls">
		<h6 class="controlsTitle" style="position:relative; top:-40px;">Opacity</h6>
		<div style="position:relative; top:-68px;">
	        <label class="tool3d" for="skinOpacity">Skin Opacity</label>
	        <input type="range" id="skinOpacity" min="0" max="1" step="0.01" value="0.05"><span id="skinOpacityLabel" class="Pspan">0.05</span>
			
			<!-- 추가된 내장 투명도 슬라이더 -->
			<label class="tool3d" for="organOpacity">Organ Opacity</label>
			<input type="range" id="organOpacity" min="0" max="1" step="0.01" value="0.6"><span id="organOpacityLabel" class="Pspan">0.6</span>
	
	        <label class="tool3d" for="muscleOpacity">Muscle Opacity</label>
	        <input type="range" id="muscleOpacity" min="0" max="1" step="0.01" value="0.5"><span id="muscleOpacityLabel" class="Pspan">0.5</span>
	
	        <label class="tool3d" for="boneOpacity">Bone Opacity</label>
	        <input type="range" id="boneOpacity" min="0" max="1" step="0.01" value="1"><span id="boneOpacityLabel" class="Pspan">0.5</span>
	        
	        <label class="tool3d" for="denseBoneOpacity">Dense Bone Opacity</label>
			<input type="range" id="denseBoneOpacity" min="0" max="1" step="0.01" value="1.0"><span id="denseBoneOpacityLabel" class="Pspan">0.5</span>
		</div>
			
		<h6 class="controlsTitle" style="position:relative; top:-80px;" >Light</h6>
		<div style="position:relative; top:-108px;">
			<label class="tool3d" for="ambientLight">Ambient Light</label>
			<input type="range" id="ambientLight" min="0" max="1" step="0.01" value="0.2"><span id="ambientLightLabel" class="Pspan">0.2</span>
			
			<label class="tool3d" for="diffuseLight">Diffuse Light</label>
			<input type="range" id="diffuseLight" min="0" max="1" step="0.01" value="0.7"><span id="diffuseLightLabel" class="Pspan">0.7</span>
			
			<label class="tool3d" for="specularLight">Specular Light</label>
			<input type="range" id="specularLight" min="0" max="1" step="0.01" value="0.3"><span id="specularLightLabel" class="Pspan">0.3</span>
		</div>
		
			<h6 class="controlsTitle" style="position:relative; top:-110px;">Position</h6>
		<div style="position:relative; top:-138px;">
	        <label class="tool3d" for="startSlice">Start Slice Position (Z-axis)</label>
	        <input type="range" id="startSlice" min="0" step="1" value="0"><br>
	
	        <label class="tool3d" for="spacingX">Spacing X</label>
	        <input type="range" id="spacingX" min="0.5" max="10" step="0.1" value="1"><br>
	
	        <label class="tool3d" for="spacingY">Spacing Y</label>
	        <input type="range" id="spacingY" min="0.5" max="10" step="0.1" value="1"><br>
	
	        <label class="tool3d" for="spacingZ">Spacing Z</label>
	        <input type="range" id="spacingZ" min="0.5" max="10" step="0.1" value="8"><br>
		</div>
	    </div>

    <script>
        // cornerstoneWADOImageLoader에 cornerstone 연결
        cornerstoneWADOImageLoader.external.cornerstone = cornerstone;

        // cornerstoneWADOImageLoader Web Worker 초기화
        cornerstoneWADOImageLoader.webWorkerManager.initialize({
            maxWebWorkers: navigator.hardwareConcurrency || 1, // 사용 가능한 CPU 코어 수에 따라 Web Worker 개수 설정
            startWebWorkersOnDemand: true, // 필요할 때만 Web Worker 시작
            webWorkerPath: 'https://unpkg.com/cornerstone-wado-image-loader/dist/cornerstoneWADOImageLoaderWebWorker.js', // Web Worker 파일 경로
            taskConfiguration: {
                decodeTask: {
                    codecsPath: 'https://unpkg.com/cornerstone-wado-image-loader/dist/cornerstoneWADOImageLoaderCodecs.js' // DICOM 디코딩을 위한 코덱 경로
                }
            }
        });

        // sessionStorage에서 imagePaths 데이터를 가져옴
        const imagePaths = JSON.parse(sessionStorage.getItem('imagePaths'));

        // imagePaths 데이터가 없을 경우 에러 출력
        if (!imagePaths) {
            console.error("Image paths not found in session storage.");
        }

        // HTML 요소에서 id 'startSlice'요소의 최대값(max)을 이미지 개수에 맞게 설정
        document.getElementById('startSlice').max = imagePaths.length - 1;

        // DICOM 이미지를 렌더링할 컨테이너 가져오기
        const renderWindowContainer = document.getElementById('dicomCanvas');
        const renderWindow = vtk.Rendering.Core.vtkRenderWindow.newInstance(); // vtk.js 렌더링 공간 생성
        const renderer = vtk.Rendering.Core.vtkRenderer.newInstance(); // 3D요소와 카메라 제어 객체 생성
        renderWindow.addRenderer(renderer); // 렌더링 공간에 Scene 추가

        // OpenGL 렌더링 초기화
        const openglRenderWindow = vtk.Rendering.OpenGL.vtkRenderWindow.newInstance();
        openglRenderWindow.setContainer(renderWindowContainer); // HTML 컨테이너 연결
        renderWindow.addView(openglRenderWindow); // OpenGL 뷰(View)를 렌더링 공간에 추가

        // 사용자 상호작용 초기화
        const interactor = vtk.Rendering.Core.vtkRenderWindowInteractor.newInstance(); // 사용자와 상호작용을 처리할 객체 생성
        interactor.setView(openglRenderWindow); // OpenGL 렌더링 뷰와 연결
        interactor.initialize(); // 상호작용 초기화
        interactor.bindEvents(renderWindowContainer); // HTML 컨테이너에 이벤트 바인딩

        // 카메라 상호작용 스타일 설정 (트랙볼 스타일)
        const interactorStyle = vtk.Interaction.Style.vtkInteractorStyleTrackballCamera.newInstance();
        interactor.setInteractorStyle(interactorStyle);

        // 3D 볼륨 데이터를 위한 vtkImageData 객체 생성
        const imageData = vtk.Common.DataModel.vtkImageData.newInstance();
        const dimensions = [512, 512, imagePaths.length]; // 데이터의 크기 설정 (가로, 세로, 슬라이스 수)
        let spacing = [1.0, 1.0, 8.0]; // 초기 spacing 설정 (x, y, z 간격)
        imageData.setDimensions(dimensions); // 데이터 크기 적용
        imageData.setSpacing(spacing); // 데이터 간격 설정

        // 초기 슬라이스 인덱스 설정
        let startSliceIndex = 0;
        let volume; // 볼륨 데이터를 저장할 변수 초기화
        const scalars = new Uint16Array(dimensions[0] * dimensions[1] * dimensions[2]); // 픽셀 데이터를 저장할 배열 생성

        // 3D 볼륨 데이터의 각 층의 투명도 설정
        let skinOpacity = 0.05; // 피부 투명도
        let muscleOpacity = 0.5; // 근육 투명도
        let boneOpacity = 1.0; // 뼈 투명도
        let denseBoneOpacity = 1.0; // 밀도 높은 뼈 투명도

        async function loadSlices() {
            if (volume) {
                renderer.removeVolume(volume);
                renderWindow.render();
            }

            const orderedPaths = [
                ...imagePaths.slice(startSliceIndex),
                ...imagePaths.slice(0, startSliceIndex),
            ];

            for (let z = 0; z < orderedPaths.length; z++) {
                const imageId = `wadouri:/dicom-file/${orderedPaths[z]}`;
                try {
                    const image = await cornerstone.loadAndCacheImage(imageId);
                    const pixelData = image.getPixelData();

                    for (let y = 0; y < dimensions[1]; y++) {
                        for (let x = 0; x < dimensions[0]; x++) {
                            const pixelValue = pixelData[y * dimensions[0] + x];
                            scalars[z * dimensions[0] * dimensions[1] + y * dimensions[0] + x] = pixelValue;
                        }
                    }
                } catch (error) {
                    console.error("Error loading image:", error);
                }
            }

            const scalarArray = vtk.Common.Core.vtkDataArray.newInstance({
                name: 'Scalars',
                numberOfComponents: 1,
                values: scalars,
            });

            imageData.getPointData().setScalars(scalarArray);
            createVolumeRendering();
        }

        function createVolumeRendering() {
		    const mapper = vtk.Rendering.Core.vtkVolumeMapper.newInstance();
		    mapper.setInputData(imageData);
		
		    // 샘플링 설정
		    mapper.setSampleDistance(0.1);
		
		    volume = vtk.Rendering.Core.vtkVolume.newInstance();
		    volume.setMapper(mapper);
		
		    const colorTransferFunction = vtk.Rendering.Core.vtkColorTransferFunction.newInstance();
		    colorTransferFunction.addRGBPoint(0, 0.5, 0.3, 0.3);
		    colorTransferFunction.addRGBPoint(500, 0.5, 0.3, 0.3);
		    colorTransferFunction.addRGBPoint(700, 0.8, 0.5, 0.4);
		    colorTransferFunction.addRGBPoint(1200, 1.0, 1.0, 1.0);
		    colorTransferFunction.addRGBPoint(3000, 1.0, 1.0, 1.0);
		
		    opacityFunction = vtk.Common.DataModel.vtkPiecewiseFunction.newInstance();
		    updateOpacityFunction();
		
		    volume.getProperty().setRGBTransferFunction(0, colorTransferFunction);
		    volume.getProperty().setScalarOpacity(0, opacityFunction);
		
		    // 조명 및 그림자 활성화
		    volume.getProperty().setShade(true); // 조명 활성화
		    volume.getProperty().setAmbient(0.2); // 주변광
		    volume.getProperty().setDiffuse(0.7); // 확산광
		    volume.getProperty().setSpecular(0.3); // 반사광
		    volume.getProperty().setSpecularPower(50.0); // 반사광 강도
		
		    // 그림자 효과 활성화
		    volume.getProperty().setUseGradientOpacity(0, true); // 그림자 활성화
		    volume.getProperty().setGradientOpacityMinimumValue(0, 5); // 최소 그라디언트 값
		    volume.getProperty().setGradientOpacityMaximumValue(0, 50); // 최대 그라디언트 값
		
		    // Interpolation 설정
		    volume.getProperty().setInterpolationTypeToLinear();
		
		    volume.getProperty().setScalarOpacityUnitDistance(0, 0.5); // 샘플링 간격 축소
		
		    renderer.addVolume(volume);
		    renderer.resetCamera();
		    renderWindow.render();
		}

        function updateOpacityFunction() {
		    opacityFunction.removeAllPoints();
		
		    // 공기: 무조건 투명
		    opacityFunction.addPoint(-1000, 0.0); // 공기
		
		    // 물: 기본 투명
		    opacityFunction.addPoint(0, 0.0);    // 물
		
		    // 피부
		    opacityFunction.addPoint(200, skinOpacity); // 피부 시작
		    opacityFunction.addPoint(500, skinOpacity); // 피부 끝
		
		    // 근육
		    opacityFunction.addPoint(600, muscleOpacity); // 근육 시작
		    opacityFunction.addPoint(800, muscleOpacity); // 근육 끝
		
		    // 장기(뇌 포함)
		    opacityFunction.addPoint(400, organOpacity);  // 장기 시작
		    opacityFunction.addPoint(700, organOpacity); // 장기 끝
		
		    // 뼈
		    opacityFunction.addPoint(1000, boneOpacity); // 일반 뼈 시작
		    opacityFunction.addPoint(1200, boneOpacity); // 일반 뼈 끝
		    opacityFunction.addPoint(2000, denseBoneOpacity); // 고밀도 뼈 시작
		    opacityFunction.addPoint(3000, denseBoneOpacity); // 고밀도 뼈 끝
		
		    renderWindow.render(); // 렌더링 갱신
		}

		
        loadSlices();
        
        
		// 내장 투명도 슬라이더 이벤트 리스너 추가
		document.getElementById('organOpacity').addEventListener('input', (event) => {
		    organOpacity = parseFloat(event.target.value);
		    document.getElementById('organOpacityLabel').innerText = organOpacity.toFixed(2);
		    updateOpacityFunction();
		});

        // 슬라이더 이벤트 리스너
        document.getElementById('skinOpacity').addEventListener('input', (event) => {
            skinOpacity = parseFloat(event.target.value);
            document.getElementById('skinOpacityLabel').innerText = skinOpacity.toFixed(2);
            updateOpacityFunction();
        });

        document.getElementById('muscleOpacity').addEventListener('input', (event) => {
            muscleOpacity = parseFloat(event.target.value);
            document.getElementById('muscleOpacityLabel').innerText = muscleOpacity.toFixed(2);
            updateOpacityFunction();
        });

        document.getElementById('boneOpacity').addEventListener('input', (event) => {
            boneOpacity = parseFloat(event.target.value);
            document.getElementById('boneOpacityLabel').innerText = boneOpacity.toFixed(2);
            updateOpacityFunction();
        });
        
        document.getElementById('denseBoneOpacity').addEventListener('input', (event) => {
		    denseBoneOpacity = parseFloat(event.target.value);
		    document.getElementById('denseBoneOpacityLabel').innerText = denseBoneOpacity.toFixed(2);
		    updateOpacityFunction();
		});

        document.getElementById('startSlice').addEventListener('input', (event) => {
            startSliceIndex = parseInt(event.target.value);
            loadSlices();
        });

        document.getElementById('spacingX').addEventListener('input', (event) => {
            spacing[0] = parseFloat(event.target.value);
            imageData.setSpacing(spacing);
            renderWindow.render();
        });

        document.getElementById('spacingY').addEventListener('input', (event) => {
            spacing[1] = parseFloat(event.target.value);
            imageData.setSpacing(spacing);
            renderWindow.render();
        });

        document.getElementById('spacingZ').addEventListener('input', (event) => {
            spacing[2] = parseFloat(event.target.value);
            imageData.setSpacing(spacing);
            renderWindow.render();
        });
        
        // 조명 슬라이더 이벤트 리스너
		document.getElementById('ambientLight').addEventListener('input', (event) => {
		    const value = parseFloat(event.target.value);
		    document.getElementById('ambientLightLabel').innerText = value.toFixed(2);
		    volume.getProperty().setAmbient(value);
		    renderWindow.render();
		});
		
		document.getElementById('diffuseLight').addEventListener('input', (event) => {
		    const value = parseFloat(event.target.value);
		    document.getElementById('diffuseLightLabel').innerText = value.toFixed(2);
		    volume.getProperty().setDiffuse(value);
		    renderWindow.render();
		});
		
		document.getElementById('specularLight').addEventListener('input', (event) => {
		    const value = parseFloat(event.target.value);
		    document.getElementById('specularLightLabel').innerText = value.toFixed(2);
		    volume.getProperty().setSpecular(value);
		    renderWindow.render();
		});
    </script>
</body>
</html>
