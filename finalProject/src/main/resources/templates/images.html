<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
	 <!--<link href="https://netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css" rel="stylesheet">-->
<head>
    <meta charset="UTF-8">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <!-- Cornerstone 및 Cornerstone Tools 라이브러리 로드 -->
	<script src="https://unpkg.com/cornerstone-core"></script>
	<script src="https://unpkg.com/cornerstone-wado-image-loader"></script>
	<script src="https://unpkg.com/cornerstone-tools"></script>
	<script src="https://unpkg.com/dicom-parser"></script>
	<script src="https://unpkg.com/cornerstone-math"></script>
	<script src="https://unpkg.com/hammerjs"></script>

    
    <!--<script src="https://cdn.jsdelivr.net/npm/cornerstone-tools@3.0.0-b.641/dist/cornerstoneTools.js"></script>
    -->
    <title>DICOM IMAGE VIEWER</title>
    <link rel="stylesheet" th:href="@{/css/image.css}">


    <!-- Thymeleaf로 서버에서 전달된 imagePaths를 JavaScript로 넘겨줌 -->
    <script th:inline="javascript">
        var imagePaths = /*[[${imagePaths}]]*/ [];
        console.log('이미지 경로 리스트:', imagePaths);
        var studyKey = /*[[${studyKey}]]*/ []; // 추가된 부분
    	console.log('Study Key:', studyKey);
        var seriesKeys = /*[[${seriesKeys}]]*/ [];
    	console.log('Series Keys:', seriesKeys);
    </script>
   

</head>
<body>
    <div class="container">
        <h2>DICOM IMAGE VIEWER</h2>
        
        <div class="wadoBox">
			<!-- 버튼 레이아웃을 프레그먼트에서 불러오기 -->
	        <div th:replace="imageView :: buttonLayout"></div>
	        
	        <!-- DICOM 이미지 뷰어 영역 -->
	        <div id="dicomImage" class="grid-container" oncontextmenu="return false" onmousedown="return false"></div>
		</div>
		
        <!-- 플레이클립 재생바 -->
		<div id="playControls" style="display: none;">
		    <button id="togglePlayBtn">멈춤</button>
		    <div style="display: inline-flex; align-items: center;">
		        <button id="decreaseSpeedBtn">-</button>
		        <input type="input" id="speedInput" min="10" max="500" value="50" step="10" style="width: 60px; text-align: center;">
		        <button id="increaseSpeedBtn">+</button>
		    </div>
		    <label for="speedInput">속도 (ms) [최대속도 10ms/최소속도 500ms]</label>
		</div>

        
    </div>
    
    
    
 <!-- 아래로는 ct사진을 3d로 구현 테스트 중인 코드 프로젝트 제출시 완성 안되면 주석처리하기  -->   
    
    
    
    <canvas id="dicomCanvas" style="display:none;"></canvas>
<div id="3dContainer"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

<script>
    // DICOM 이미지가 렌더링될 <canvas>와 3D 씬이 렌더링될 <div> 요소를 가져옴
    const dicomElement = document.getElementById('dicomCanvas');
    const container = document.getElementById('3dContainer');

    // cornerstoneWADOImageLoader 초기화
    cornerstoneWADOImageLoader.external.cornerstone = cornerstone;  // Cornerstone을 WADO 로더와 연결
    cornerstoneWADOImageLoader.webWorkerManager.initialize({
        maxWebWorkers: navigator.hardwareConcurrency || 1, // 시스템의 코어 수에 맞춰 Web Worker 개수 설정
        startWebWorkersOnDemand: true, // 필요할 때만 Web Worker를 시작
        webWorkerPath: 'https://unpkg.com/cornerstone-wado-image-loader/dist/cornerstoneWADOImageLoaderWebWorker.js', // Web Worker 파일 경로 설정
        taskConfiguration: {
            decodeTask: {
                codecsPath: 'https://unpkg.com/cornerstone-wado-image-loader/dist/cornerstoneWADOImageLoaderCodecs.js' // DICOM 디코딩 코덱 파일 경로 설정
            }
        }
    });

    // Cornerstone 활성화
    cornerstone.enable(dicomElement); // DICOM 이미지를 렌더링할 <canvas> 요소 활성화

    // 각 슬라이스 이미지를 저장할 배열
    const slices = [];

    // DICOM 슬라이스 이미지를 로드하는 비동기 함수
    async function loadSlices() {
        // imagePaths 배열의 각 파일에 대해 이미지 로드를 비동기로 처리
        const promises = imagePaths.map(async filename => {
            const imageId = `wadouri:/dicom-file/${filename}`; // 이미지 경로 구성
            try {
                const image = await cornerstone.loadAndCacheImage(imageId); // DICOM 이미지 로드
                slices.push(image); // 슬라이스 배열에 이미지 추가
            } catch (error) {
                console.error("Error loading image:", error); // 이미지 로드 오류 처리
            }
        });

        await Promise.all(promises); // 모든 슬라이스 로드가 완료될 때까지 대기
        render3DVolume(); // 모든 슬라이스 로드 후 3D 볼륨 렌더링 시작
    }

    // Three.js를 사용해 3D 볼륨을 렌더링하는 함수
    function render3DVolume() {
        const scene = new THREE.Scene(); // 3D 씬 생성
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000); // 원근 카메라 생성
        const renderer = new THREE.WebGLRenderer(); // WebGL 렌더러 생성
        renderer.setSize(window.innerWidth, window.innerHeight); // 렌더러 크기 설정
        container.appendChild(renderer.domElement); // 렌더러의 <canvas>를 화면에 추가

        // 3D 볼륨을 위한 기본 상자 모양의 기하구조 생성 (가로 1, 세로 1, 깊이 slices.length / 10)
        const geometry = new THREE.BoxGeometry(1, 1, slices.length / 10);

        // 각 슬라이스에 대한 텍스처와 재질 생성
        const materials = slices.map(slice => {
            const pixelData = new Uint8Array(slice.getPixelData().buffer); // Cornerstone의 픽셀 데이터를 Uint8Array로 변환
            const texture = new THREE.DataTexture(pixelData, slice.width, slice.height, THREE.LuminanceFormat); // DataTexture를 LuminanceFormat으로 생성
            texture.needsUpdate = true; // 텍스처 업데이트 플래그 설정
            return new THREE.MeshBasicMaterial({ map: texture, side: THREE.DoubleSide }); // 텍스처로 구성된 재질 생성
        });

        const volume = new THREE.Mesh(geometry, materials); // 기하구조와 재질로 3D 볼륨 생성
        scene.add(volume); // 3D 볼륨을 씬에 추가

        // 환경광(ambient light)을 추가해 씬 전체에 균일한 조명 적용
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.5); // 광원의 색상은 흰색, 강도는 0.5
        scene.add(ambientLight);

        // 방향광(directional light)을 추가해 특정 방향에서의 조명 적용
        const directionalLight = new THREE.DirectionalLight(0xffffff, 1); // 광원의 색상은 흰색, 강도는 1
        directionalLight.position.set(5, 5, 5).normalize(); // 광원의 위치 설정
        scene.add(directionalLight);

        camera.position.z = 3; // 카메라 위치 설정 (z 축을 따라 뒤로 이동해 3D 볼륨을 볼 수 있게 함)

        // 애니메이션 함수로 3D 볼륨을 회전시키며 렌더링
        function animate() {
            requestAnimationFrame(animate); // 매 프레임마다 animate 함수를 호출
            volume.rotation.y += 0.01; // y축을 기준으로 볼륨 회전
            renderer.render(scene, camera); // 씬과 카메라를 사용해 렌더링
        }
        animate(); // 애니메이션 시작
    }

    loadSlices(); // DICOM 슬라이스 로드 함수 호출
</script>

    <!-- JavaScript 파일 포함 -->
    <script src="/js/list.js"></script>
    <script src="/js/imgTool/prevNext.js"></script>
    <script src="/js/imgTool/invert.js"></script>   
    <!--<script src="/js/imgTool/brightness.js"></script>  --> 
    <script src="/js/imgTool/playClip.js"></script> 
    <script src="/js/imgTool/viewSeries.js"></script> 
    <script src="/js/imgTool/tool.js"></script>
    <script src="/js/imgTool/annotate.js"></script>
    <script src="/js/imgTool/reset.js"></script>
	<script src="/js/imgTool/seriesLayout.js"></script>
	<script src="/js/imgTool/imgLayout.js"></script>
	<script src="/js/imageView.js"></script>
	<script src="/js/testjs.js"></script>
	

</body>
</html>
